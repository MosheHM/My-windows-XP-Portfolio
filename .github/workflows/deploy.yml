name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggers

jobs:
  deploy:
    name: Deploy to moshe-makies.dev
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'ENDSSH'
            set -e

            echo "üöÄ Starting deployment to moshe-makies.dev..."

            TARGET_DIR="$HOME/portfolio"

            # Navigate to project directory or clone if it doesn't exist
            if [ -d "$TARGET_DIR/.git" ]; then
              cd "$TARGET_DIR"
              echo "üì¶ Pulling latest changes..."
              git pull origin main
            else
              echo "üì¶ Cloning repository into $TARGET_DIR..."
              mkdir -p "$TARGET_DIR"
              git clone https://github.com/MosheHM/My-windows-XP-Portfolio.git "$TARGET_DIR"
              cd "$TARGET_DIR"
            fi

            # Check docker - if docker requires sudo, use sudo prefix
            if docker info >/dev/null 2>&1; then
              DOCKER_CMD="docker"
            else
              echo "‚ÑπÔ∏è docker requires sudo; using sudo for docker commands"
              DOCKER_CMD="sudo docker"
            fi

            # Build Docker images
            echo "üî® Building Docker images..."
            $DOCKER_CMD build -t portfolio-client:latest ./client
            $DOCKER_CMD build -t llm-service:latest ./services/llm-service
            $DOCKER_CMD build -t file-service:latest ./services/file-service

            # Deploy to Kubernetes
            echo "‚ò∏Ô∏è  Deploying to Kubernetes..."
            kubectl apply -f k8s/namespace.yaml
            kubectl apply -f k8s/configmap.yaml -n portfolio
            kubectl apply -f k8s/llm-service-deployment.yaml -n portfolio
            kubectl apply -f k8s/file-service-deployment.yaml -n portfolio
            kubectl apply -f k8s/client-deployment.yaml -n portfolio

            echo "‚è≥ Waiting for services to be ready..."
            kubectl wait --for=condition=available --timeout=300s deployment/portfolio-client -n portfolio || true
            kubectl wait --for=condition=available --timeout=300s deployment/file-service -n portfolio || true

            echo "üìä Deployment status:"
            kubectl get pods -n portfolio

            NODE_PORT=$(kubectl get svc client-service -n portfolio -o jsonpath='{.spec.ports[0].nodePort}')
            echo "‚úÖ Deployment successful!"
            echo "üåê Application is running at http://moshe-makies.dev:${NODE_PORT}"

            echo "üßπ Cleaning up old Docker images..."
            $DOCKER_CMD image prune -f

          ENDSSH

      - name: Verify deployment
        run: |
          echo "‚úÖ Deployment completed!"
          echo "üåê Visit: http://moshe-makies.dev"
